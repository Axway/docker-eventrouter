variables:
  NAME: event-router
  DOCKER_REPO: sentineleventrouter-docker-snapshot-ptx.artifactory-ptx.ecd.axway.int
  RPM_REPO: https://artifactory-ptx.ecd.axway.int/artifactory/sentineleventrouter-generic-snapshot-ptx
  CURL_IMAGE: "davinci1976/docker-ci:unstable"
  CURL_AXWAY: "curl --cacert ./AxwayRootCA.cer"

  # Security images
  WHITESOURCE_DOCKER_IMAGE: psg-docker-release.artifactory-ptx.ecd.axway.int/whitesource:latest
  FORTIFY_DOCKER_IMAGE: psg-docker-release.artifactory-ptx.ecd.axway.int/fortify/fortify-mvn-jdk-8:latest
  TWISTLOCK_IMAGE: psg-docker-release.artifactory-ptx.ecd.axway.int/psg-tools/docker:latest

#include:
#  - template: Code-Quality.gitlab-ci.yml

default:
  tags:
    - docker-ex
  before_script:
    - eval export CI_COMMIT_BRANCH=$(echo "$CI_COMMIT_BRANCH" | tr '[:upper:]' '[:lower:]')
    - echo using commit $CI_COMMIT_BRANCH
    - eval export DOCKER_IMAGE=$DOCKER_REPO/$NAME:$CI_COMMIT_BRANCH
    - echo using image $DOCKER_IMAGE

stages:
  - prepare
  - build
  - pack
  - test
  - deploy
  - security

version:
  image: davinci1976/docker-ci:unstable
  stage: prepare
  script:
    - ./scripts/setVersion.sh
  artifacts:
    paths:
      - ./.env

unit-test:
  image: docker
  needs: []
  stage: prepare
  #coverage: "/\\(statements\\)(?:\\s+)?(\\d+(?:\\.\\d+)?%)/"
  script:
    - ./scripts/run-unit-test-docker.sh

.build:
  image: golang:bookworm
  stage: build
  needs:
    - version
    - unit-test
  cache:
    paths:
      - .cache/
    key: GO
  script:
    - (test -d /artefacts && ln -s /artefacts ./artefacts) || mkdir -p artefacts
    - ls -l .cache || true
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - make build-glibc
    - ./$NAME version
    - cp $NAME ./artefacts/
  artifacts:
    paths:
      - ./artefacts/$NAME
    expire_in: 2 day

build-glibc:
  image: docker
  stage: build
  needs:
    - version
  script:
    - (test -d /artefacts && ln -s /artefacts ./artefacts) || mkdir -p artefacts
    - ./scripts/run-build-docker.sh
    - chmod +x $NAME
    - cp $NAME ./artefacts/
  artifacts:
    paths:
      - ./artefacts/$NAME

build-docker:
  image: davinci1976/docker-ci:unstable
  stage: build
  needs:
    - version
    - unit-test
  script:
    - docker build --pull -f ./Dockerfile -t $DOCKER_IMAGE .
    - docker run --rm $DOCKER_IMAGE $NAME version

integration-test-reset:
  image: docker
  needs: []
  when: manual
  stage: test
  #coverage: "/\\(statements\\)(?:\\s+)?(\\d+(?:\\.\\d+)?%)/"
  script:
    - ./scripts/run-integration-test-docker.sh reset
  artifacts:
    when: always
    reports:
      junit: report.xml
      #coverage_report:
      #  coverage_format: cobertura
      #  path: coverage.xml

integration-test:
  image: docker
  needs:
    - build-docker
  stage: test
  cache:
    paths:
      - .cache/
    key: GO
  coverage: "/\\(statements\\)(?:\\s+)?(\\d+(?:\\.\\d+)?%)/"
  script:
    - ./scripts/run-integration-test-docker.sh reset
  artifacts:
    when: always
    paths:
      - coverage.svg
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

rpm-build:
  image: rpmbuild/centos7
  needs:
    - version
    - build-glibc
  stage: pack
  script:
    - test -d /artefacts && ln -s /artefacts ./artefacts
    - . ./.env
    - ./rpm/rpm-build.sh $NAME $VERSION
  artifacts:
    paths:
      - ./artefacts/$NAME*.rpm
    expire_in: 2 day

rpm-test:
  image: davinci1976/docker-ci:unstable
  needs:
    - version
    - rpm-build
  stage: test
  script:
    #- test ! -e ./artefacts && ln -s /artefacts ./artefacts
    - test ! -e ./artefacts && cp -rf /artefacts ./artefacts/
    - ./rpm/rpm-test.sh $NAME

rpm-snapshot:
  image: $CURL_IMAGE
  stage: deploy
  dependencies:
    - version
    - rpm-build
  script:
    - . ./.env
    - $CURL_AXWAY -k -v -u $ARTIFACTORY_USER:$ARTIFACTORY_TOKEN -T ./artefacts/$NAME*.rpm "$RPM_REPO/$NAME/$NAME-$CI_COMMIT_BRANCH.rpm"

docker-snapshot:
  image: docker
  stage: deploy
  dependencies:
    - version
  before_script:
    - docker login -u $ARTIFACTORY_USER -p $ARTIFACTORY_TOKEN $DOCKER_REPO
    - . ./.env
    - eval export CI_COMMIT_BRANCH=$(echo "$CI_COMMIT_BRANCH" | tr '[:upper:]' '[:lower:]')
    - eval export DOCKER_IMAGE=$DOCKER_REPO/$NAME:$CI_COMMIT_BRANCH
    - echo using image $DOCKER_IMAGE
  script:
    - echo $VERSION
    - docker build --pull -f ./Dockerfile -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE

fortify:
  image: $FORTIFY_DOCKER_IMAGE
  stage: security
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - when: manual
  before_script:
    - apt-get update -y
    - apt-get install git -y
  script:
    - git clone https://cft_read:$GIT_CFT_READ_TOKEN@git.ecd.axway.org/cft/qlt-router.git qlt-router
    - cd qlt-router
    - git checkout master
    - sourceanalyzer -b er_fortify **/src/**/*.go -verbose -logfile ./log.txt
    - scancentral -sscurl $SSC_URL -ssctoken $SSC_CONTROL_TOKEN start -upload -versionid 10854 -uptoken $SSC_UPLOAD_TOKEN -b er_fortify -scan -mt

twistlock:
  image: $TWISTLOCK_IMAGE
  stage: security
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - when: manual
  script:
    - out=`twistcli images scan -u $TWISTLOCK_USER -p "$TWISTLOCK_PASSWORD" --address $TWISTLOCK_URL $DOCKER_IMAGE`
    - echo $out
    - eval export SEARCHING=`echo $out | cut -d ' ' -f 5 | cut -d '/' -f 2`
    - echo get scan result for image=$SEARCHING
    # Retrieve the scan result
    - "curl --insecure -u$TWISTLOCK_USER:$TWISTLOCK_PASSWORD -H \"Content-Type: application/json\" -X GET $TWISTLOCK_URL\"api/v1/scans?search=$SEARCHING&sort=time&reverse=true&limit=1&type=ciImage\" >analysis.json"
    # Upload the scan result to ThreadFix
    - "curl --insecure -H \"Authorization: APIKEY $THREADFIX_APIKEY\" -H \"Accept: application/json\" -X POST --form \"file=@analysis.json\" https://vulnmgt.psg.axway.int/threadfix/rest/v2.5/applications/$THREADFIX_APPID/upload"
    # Remove scan results.
    - rm -f analysis.json
