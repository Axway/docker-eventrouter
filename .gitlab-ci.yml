variables:
  NAME: qlt-router

stages:
  - build
  - pack
  - test
  - deploy
  - security

build:
  image: golang:1.20.2
  stage: build
  cache:
    paths:
      - .cache/
    key: GO
  tags:
    - docker-ex
  script:
    - ls -l .cache || true
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - ./scripts/setVersion.sh
    - make
    - ./$NAME version
  artifacts:
    paths:
      - $NAME
      - ./.env
    expire_in: 2 day

rpm:
  image: rpmbuild/centos7
  dependencies:
    - build
  needs:
    - build
  stage: pack
  tags:
    - docker-ex
  script:
    - ./rpm/build-rpm.sh
  artifacts:
    paths:
      - ./rpm/qlt-router*.rpm
      - ./.env
    expire_in: 2 day

test-rpm-pack:
  dependencies:
    - rpm
  needs:
    - rpm
  stage: test
  script:
    - ./agent-rpm/test-rpm.sh

build-docker:
  stage: build
  script:
    - ./scripts/setVersion.sh
    - docker build --pull -f ./Dockerfile -t qlt-router:$CI_COMMIT_SHA .
    - docker rmi flowmanager-agent:$CI_COMMIT_SHA
